name: linux-release

on: workflow_dispatch

env:
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 5.15.2
  ARTIFACT:   qtneonbtl-linux-build.AppDir

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          version: ${{ env.QT_VERSION }}
          target: desktop
          modules: qtmultimedia
          install-deps: 'true'

      - name: Install packages
        run: sudo apt-get install fuse libfuse2

      - name: Get linuxdeployqt
        run: |
          wget -nv -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod a+x linuxdeployqt-continuous-x86_64.AppImage
    
      - name: Versions
        run: qmake -v

      - name: Create build directory
        run: |
          mkdir ${{ env.SOURCE_DIR }}/build
          mkdir -p ${{ env.SOURCE_DIR }}/build/usr/bin
          mkdir -p ${{ env.SOURCE_DIR }}/build/usr/share
          mkdir -p ${{ env.SOURCE_DIR }}/build/usr/share/applications

      - name: Build
        run: |
          cd emulator
          qmake "CONFIG+=release" QtNeonBtl.pro
          make

      - name: Packaging
        working-directory: ${{ env.SOURCE_DIR }}/build
        run: |
          cp ${{ env.SOURCE_DIR }}/emulator/QtNeonBtl ./usr/bin/
          cp ${{ env.SOURCE_DIR }}/linux/qtneonbtl.desktop ./usr/share/applications/
          ../linuxdeployqt-continuous-x86_64.AppImage ./usr/share/applications/qtneonbtl.desktop -appimage -no-translations -verbose=3
          ls -l
          mv qtneonbtl-*.AppDir ${{ env.ARTIFACT }}

      - name: Linux artefact
        uses: actions/upload-artifact@v1
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ env.SOURCE_DIR }}/build/${{ env.ARTIFACT }}
